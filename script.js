
const translations = {
        ru: {
            "page-title": "ineedmypills",
            "main-title": "ineedmypills",
            "alt-header-title": "Коктейльчик",
            "full-name": "Глухих Егор Алексеевич",
            "specialist": "Начинающий многосторонне развитый IT-\"специалист\"",
            "skills-title": "Технические навыки",
            "lang-title": "Языки программирования",
            "software-title": "Программное обеспечение",
            "ai-skill": "Владение ИИ",
            "projects-title": "Ключевые проекты",
            "games-category-title": "Игры",
            "software-category-title": "Программное обеспечение",
            "fh3-desc": "Неофициальное переиздание игры Final Hours 3",
            "npc-desc": "\"Почувствуйте, каково это - быть неигровым персонажем.\"",
            "npc-jam": "Игра для",
            "judges-5th": "5 место (судьи)",
            "players-28th": "28 место (игроки)",
            "kolobok-desc": "Увлекательный 3D шутер-платформер, вдохновлённый игрой \"My Friend Pedro\", с видом сбоку в стилистике \"Киберпанка\"",
            "obs-desc": "Компактный экранный индикатор для записи и буфера повтора в OBS Studio",
            "completed": "Завершенный проект",
            "in-progress": "В разработке",
            "course-completed": "Окончил",
            "course-in-progress": "В процессе",
            "education-title": "Образование",
            "secondary-edu": "Среднее общее образование",
            "11-classes": "11 классов",
            "computer-academy": "Компьютерная Академия \"ТОП\"",
            "specialization": "Специализация: разработка программного обеспечения",
            "first-year": "1 курс",
            "second-year": "2 курс",
            "third-year": "3 курс",
            "first-place": "1 место в группе",
            "project-defense": "Защитил проект по Unreal Engine",
            "contacts-title": "Контакты",
            "about-title": "О себе",
            "about-text": "Увлеченный геймдевелопер с разносторонним техническим бэкграундом. Страстно увлечен созданием игр - от концепции до релиза. Участвую в Game Jams для оттачивания навыков работы в сжатые сроки. Экспериментирую с интеграцией ИИ в творческие процессы. Обладаю упорством в доведении проектов до завершения и креативным подходом к решению технических задач. Постоянно осваиваю новые технологии и инструменты разработки.",
            "interest-gamedev": "Разработка инди-игр",
            "interest-software": "Разработка ПО",
            "interest-ai": "Генеративное искусство и нейросети",
            "interest-music": "Создание электронной музыки",
            "interest-youtuber": "Ютубер",
            "support-title": "Поддержать",
            "t-bank": "Т-Банк",
            "no-commission": "Без комиссии",
            "commission-3.5": "Комиссия 3,5%",
            "commission-10": "Комиссия 10%",
            "recommended": "Рекомендуется",
            "not-recommended-rf": "не рекомендуется для РФ",
            "backup-option": "Запасной вариант",
            "bank-transfer-title": "Банковский перевод",
            "donations-title": "Донаты",
            "crypto-title": "Криптовалюта",
            "bank-desc": "Самый удобный способ без комиссии",
            "donations-desc": "Если хотите, чтобы ваше сообщение появилось на стриме",
            "crypto-desc": "Для ценителей анонимности и современных технологий",
            "copy-to-clipboard": "Нажмите, чтобы скопировать",
            "copied-feedback": "Скопировано!",
            "share-title": "Конструктор ссылки",
            "share-desc": "Выберите секции, которые хотите показать:",
            "share-copy": "Копировать",
            "share-copied": "Скопировано!",
            "share-button-aria": "Поделиться",
            "share-header": "Заголовок",
            "share-alt-header": "Альтернативный заголовок",
            "share-subtitle": "Подзаголовок",
            "share-full-name": "ФИО",
            "optimal": "Оптимально",
            "lts": "Долгосрочная поддержка"
        },
        en: {
            "page-title": "ineedmypills",
            "main-title": "ineedmypills",
            "alt-header-title": "Milky",
            "full-name": "Glukhikh Egor Alekseevich",
            "specialist": "Beginning versatile IT \"specialist\"",
            "skills-title": "Technical Skills",
            "lang-title": "Programming Languages",
            "software-title": "Software",
            "ai-skill": "AI Proficiency",
            "projects-title": "Key Projects",
            "games-category-title": "Games",
            "software-category-title": "Software",
            "fh3-desc": "Unofficial remake of Final Hours 3 game",
            "npc-desc": "\"Experience what it's like to be a non-playable character.\"",
            "npc-jam": "Game for",
            "judges-5th": "5th place (judges)",
            "players-28th": "28th place (players)",
            "kolobok-desc": "Engaging 3D shooter-platformer inspired by \"My Friend Pedro\", with a side view in \"Cyberpunk\" style",
            "obs-desc": "Compact on-screen indicator for OBS Studio recording and replay buffer status",
            "completed": "Completed project",
            "in-progress": "In development",
            "course-completed": "Finished",
            "course-in-progress": "In progress",
            "education-title": "Education",
            "secondary-edu": "General secondary education",
            "11-classes": "11 grades",
            "computer-academy": "TOP Computer Academy",
            "specialization": "Specialization: software development",
            "first-year": "1st course",
            "second-year": "2nd course",
            "third-year": "3rd course",
            "first-place": "1st place in the group",
            "project-defense": "Defended Unreal Engine project",
            "contacts-title": "Contacts",
            "about-title": "About Me",
            "about-text": "Passionate game developer with a versatile technical background. Deeply engaged in game creation from concept to release. Participate in Game Jams to hone skills in tight deadlines. Experiment with AI integration in creative processes. Possess persistence in completing projects and a creative approach to solving technical challenges. Continuously learning new technologies and development tools.",
            "interest-gamedev": "Indie Game Development",
            "interest-software": "Software Development",
            "interest-ai": "Generative Art and Neural Networks",
            "interest-music": "Electronic Music Creation",
            "interest-youtuber": "YouTuber",
            "support-title": "Support",
            "t-bank": "T-Bank",
            "no-commission": "No commission",
            "commission-3.5": "Commission 3.5%",
            "commission-10": "Commission 10%",
            "recommended": "Recommended",
            "not-recommended-rf": "not recommended for RF",
            "backup-option": "Backup option",
            "bank-transfer-title": "Bank Transfer",
            "donations-title": "Donations",
            "crypto-title": "Cryptocurrency",
            "bank-desc": "The most convenient way with no commission",
            "donations-desc": "If you want your message to appear on the stream",
            "crypto-desc": "For connoisseurs of anonymity and modern technology",
            "copy-to-clipboard": "Click to copy",
            "copied-feedback": "Copied!",
            "share-title": "Link Builder",
            "share-desc": "Select sections to display:",
            "share-copy": "Copy",
            "share-copied": "Copied!",
            "share-button-aria": "Share",
            "share-header": "Header",
            "share-alt-header": "Alternative Header",
            "share-subtitle": "Subtitle",
            "share-full-name": "Full Name",
            "optimal": "Optimal",
            "lts": "Long Term Support"
        }
    };

    document.addEventListener('DOMContentLoaded', () => {
        const themeToggle = document.getElementById('themeToggle');
        const html = document.documentElement;
        const agePlaceholder = document.getElementById('agePlaceholder');
        const elementsToAnimate = document.querySelectorAll('.animate-on-scroll');
        const BIRTH_DATE = '2006-06-12';

        // --- КОД ДЛЯ ФУНКЦИИ "ПОДЕЛИТЬСЯ" ---
        const shareButton = document.getElementById('shareButton');
        const shareModal = document.getElementById('shareModal');
        const allSections = document.querySelectorAll('main.content > section[id]');

        if (shareModal) {
            const shareModalCloseButton = document.getElementById('shareModalCloseButton');
            const shareOptions = document.getElementById('shareOptions');
            const shareCheckboxes = shareOptions.querySelectorAll('input[type="checkbox"]');
            const shareLinkInput = document.getElementById('shareLinkInput');
            const copyLinkButton = document.getElementById('copyLinkButton');
            const linkWrapper = copyLinkButton.parentElement;

            const headerCheckbox = shareOptions.querySelector('input[value="header"]');
            const altHeaderCheckbox = shareOptions.querySelector('input[value="alt_header"]');
            const subtitleCheckbox = shareOptions.querySelector('input[value="subtitle"]');
            const fullNameCheckbox = shareOptions.querySelector('input[value="full_name"]');
            const headerSubgroup = document.getElementById('header-options-subgroup');


            const generateShareLink = () => {
                const selectedValues = new Set(
                    Array.from(shareCheckboxes)
                        .filter(cb => cb.checked)
                        .map(cb => cb.value)
                );

                const sectionItems = new Set(['skills', 'projects', 'education', 'about', 'contacts', 'support']);
                const hasAtLeastOneSection = [...selectedValues].some(item => sectionItems.has(item));
                const isEffectivelyEmpty = selectedValues.size === 0;
                const isInvalid = !isEffectivelyEmpty && !hasAtLeastOneSection && selectedValues.has('header');

                copyLinkButton.disabled = isEffectivelyEmpty || isInvalid;
                linkWrapper.style.opacity = (isEffectivelyEmpty || isInvalid) ? 0.5 : 1;
                linkWrapper.style.pointerEvents = (isEffectivelyEmpty || isInvalid) ? 'none' : 'auto';

                if (isEffectivelyEmpty || isInvalid) {
                    shareLinkInput.value = '';
                    return;
                }

                const allCheckboxValues = new Set(Array.from(shareCheckboxes).map(cb => cb.value));
                const defaultValues = new Set(allCheckboxValues);
                defaultValues.delete('alt_header');

                const setsAreEqual = (a, b) => a.size === b.size && [...a].every(value => b.has(value));
                const isDefaultState = setsAreEqual(selectedValues, defaultValues);

                if (isDefaultState) {
                    shareLinkInput.value = window.location.origin + window.location.pathname;
                } else {
                    const params = new URLSearchParams();
                    params.set('show', [...selectedValues].join(','));
                    shareLinkInput.value = `${window.location.origin}${window.location.pathname}?${params.toString()}`;
                }
            };

            const openShareModal = () => {
                generateShareLink();
                document.body.classList.add('modal-is-open');
                shareModal.classList.remove('hidden');
            };

            const closeShareModal = () => {
                document.body.classList.remove('modal-is-open');
                shareModal.classList.add('hidden');
            };

            shareButton.addEventListener('click', openShareModal);
            shareModalCloseButton.addEventListener('click', closeShareModal);

            shareModal.addEventListener('click', (e) => {
                if (e.target === shareModal) {
                    closeShareModal();
                }
            });

            shareCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', generateShareLink);
            });

            if (headerCheckbox && subtitleCheckbox && altHeaderCheckbox && fullNameCheckbox && headerSubgroup) {
                const updateHeaderDependencies = () => {
                    const isHeaderChecked = headerCheckbox.checked;

                    headerSubgroup.style.opacity = isHeaderChecked ? 1 : 0.5;

                    [subtitleCheckbox, altHeaderCheckbox, fullNameCheckbox].forEach(cb => {
                        const label = cb.parentElement;
                        cb.disabled = !isHeaderChecked;
                        label.style.cursor = isHeaderChecked ? 'pointer' : 'not-allowed';
                        if (!isHeaderChecked) cb.checked = false;
                    });
                };

                headerCheckbox.addEventListener('change', () => {
                    updateHeaderDependencies();
                    generateShareLink();
                });
                updateHeaderDependencies();
            }

            copyLinkButton.addEventListener('click', () => {
                if (!navigator.clipboard || copyLinkButton.disabled) return;
                navigator.clipboard.writeText(shareLinkInput.value).then(() => {
                    const currentLang = document.documentElement.lang || 'ru';
                    const originalText = translations[currentLang]['share-copy'];
                    const copiedText = translations[currentLang]['share-copied'];

                    copyLinkButton.textContent = copiedText;
                    copyLinkButton.disabled = true;

                    setTimeout(() => {
                        copyLinkButton.textContent = originalText;
                        generateShareLink();
                    }, 2000);
                });
            });
        }

        const handleSharedLinkView = () => {
            const params = new URLSearchParams(window.location.search);
            const sectionsToShowParam = params.get('show');

            if (sectionsToShowParam) {
                const visibleItems = new Set(sectionsToShowParam.split(','));
                const header = document.querySelector('header');
                const subtitle = document.getElementById('header-subtitle');
                const nameEl = document.getElementById('main-header-name');
                const mainTitleEl = document.getElementById('main-header-title');

                if (shareButton) shareButton.style.display = 'none';

                if (header) {
                    if (visibleItems.has('header')) {
                        header.style.display = 'block';
                        const currentLang = document.documentElement.lang || 'ru';

                        if (visibleItems.has('alt_header')) {
                            if (mainTitleEl) mainTitleEl.textContent = translations[currentLang]['alt-header-title'];
                        }

                        if (nameEl && !visibleItems.has('full_name')) {
                            nameEl.style.display = 'none';
                        }
                        if (subtitle && !visibleItems.has('subtitle')) {
                            subtitle.style.display = 'none';
                        }
                    } else {
                        header.style.display = 'none';
                    }
                }

                allSections.forEach(section => {
                    const sectionId = section.id.replace('-section', '');
                    section.style.display = visibleItems.has(sectionId) ? 'block' : 'none';
                });
            }
        };

        function applyTheme(theme) {
            html.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
        }

        function applyLanguage(lang) {
            html.setAttribute('lang', lang);
            document.querySelectorAll('.translate-element').forEach(el => {
                const key = el.getAttribute('data-key');
                if (key && translations[lang]?.[key]) {
                    el.innerHTML = translations[lang][key];
                }
            });
            document.title = translations[lang]['page-title'] || 'ineedmypills';
            if (shareButton) {
                shareButton.setAttribute('aria-label', translations[lang]['share-button-aria']);
            }
            displayAge(lang);
        }

        function calculateAge(birthDate) {
            const today = new Date();
            const birth = new Date(birthDate);
            let age = today.getFullYear() - birth.getFullYear();
            const monthDiff = today.getMonth() - birth.getMonth();
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                age--;
            }
            return age;
        }

        function displayAge(lang) {
            const age = calculateAge(BIRTH_DATE);
            if (lang === 'ru') {
                agePlaceholder.textContent = `Возраст: ${age} лет`;
            } else {
                agePlaceholder.textContent = `Age: ${age} years`;
            }
        }

        function setupInterestLink(buttonId, sectionId) {
            const button = document.getElementById(buttonId);
            const section = document.getElementById(sectionId);

            if (!button || !section) return;

            const highlightAnimation = () => {
                const cards = section.querySelectorAll('.project-card');
                cards.forEach((card, index) => {
                    setTimeout(() => {
                        card.classList.add('pulse-highlight');
                        card.addEventListener('animationend', () => {
                            card.classList.remove('pulse-highlight');
                        }, { once: true });
                    }, index * 150);
                });
            };

            const scrollObserver = new IntersectionObserver((entries, observer) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        highlightAnimation();
                        observer.unobserve(section);
                    }
                });
            }, { threshold: 0.5 });

            button.addEventListener('click', (e) => {
                e.preventDefault();
                scrollObserver.observe(section);
                section.scrollIntoView({ behavior: 'smooth', block: 'center' });
            });
        }

        function setupRunawayButton() {
            const button = document.getElementById('youtuber-button');
            if (!button) return;
            const container = button.parentElement;

            let initialTop, initialLeft;
            let isInitialized = false;

            const leashRadius = 35;

            const initPosition = () => {
                if (!isInitialized) {
                    initialTop = button.offsetTop;
                    initialLeft = button.offsetLeft;
                    button.style.position = 'relative';
                    isInitialized = true;
                }
            };

            container.addEventListener('mousemove', (e) => {
                initPosition();
                const containerRect = container.getBoundingClientRect();
                const mouseX = e.clientX - containerRect.left;
                const mouseY = e.clientY - containerRect.top;

                const buttonCenterX = initialLeft + button.offsetWidth / 2;
                const buttonCenterY = initialTop + button.offsetHeight / 2;

                const dx = mouseX - buttonCenterX;
                const dy = mouseY - buttonCenterY;
                const distance = Math.sqrt(dx * dx + dy * dy);

                const activationRadius = leashRadius * 3.5;

                if (distance < activationRadius) {
                    const angle = Math.atan2(dy, dx);
                    const force = 1 - (distance / activationRadius);

                    const moveX = -Math.cos(angle) * leashRadius * force;
                    const moveY = -Math.sin(angle) * leashRadius * force;

                    button.style.transform = `translate(${moveX}px, ${moveY}px)`;
                } else {
                    button.style.transform = 'translate(0, 0)';
                }
            });

            container.addEventListener('mouseleave', () => {
                if (isInitialized) {
                    button.style.transform = 'translate(0, 0)';
                }
            });
        }

        function setupCopyToClipboard() {
            let lastCopied = { element: null, timeoutId: null };

            document.querySelectorAll('[data-address]').forEach(el => {
                const textEl = el.querySelector('.crypto-commission');
                if (!textEl) return;

                el.addEventListener('click', () => {
                    const address = el.dataset.address;
                    if (!address) return;

                    if (lastCopied.element && lastCopied.element !== el) {
                        clearTimeout(lastCopied.timeoutId);
                        const prevTextEl = lastCopied.element.querySelector('.crypto-commission');
                        const currentLang = document.documentElement.lang || 'ru';
                        if (prevTextEl) {
                            prevTextEl.textContent = translations[currentLang]['copy-to-clipboard'];
                            lastCopied.element.classList.remove('is-copied');
                        }
                    }

                    if (lastCopied.element === el) return;

                    navigator.clipboard.writeText(address).then(() => {
                        const currentLang = document.documentElement.lang || 'ru';
                        const copiedText = translations[currentLang]['copied-feedback'];

                        textEl.textContent = copiedText;
                        el.classList.add('is-copied');

                        lastCopied.element = el;
                        lastCopied.timeoutId = setTimeout(() => {
                            const originalText = translations[currentLang]['copy-to-clipboard'];
                            textEl.textContent = originalText;
                            el.classList.remove('is-copied');
                            if (lastCopied.element === el) {
                                lastCopied.element = null;
                                lastCopied.timeoutId = null;
                            }
                        }, 2000);
                    }).catch(err => {
                        console.error('Failed to copy address: ', err);
                    });
                });
            });
        }

        themeToggle.addEventListener('click', () => {
            const newTheme = html.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
            applyTheme(newTheme);
        });

        document.body.addEventListener('click', e => {
            const card = e.target.closest('[data-url]');
            if (!card) return;

            if (e.target.closest('a, .tech-badge')) {
                return;
            }

            const url = card.dataset.url;
            if (url) {
                window.open(url, '_blank');
            }
        });

        const observer = new IntersectionObserver((entries, observerInstance) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('is-visible');
                    const children = entry.target.querySelectorAll('.stagger-child');
                    children.forEach((child, index) => {
                        child.style.transitionDelay = `${index * 100}ms`;
                    });
                    observerInstance.unobserve(entry.target);
                }
            });
        }, { threshold: 0.1 });

        elementsToAnimate.forEach(el => observer.observe(el));

        // --- ИНИЦИАЛИЗАЦИЯ ---

        // 1. Определяем и применяем тему: 1. localStorage, 2. Системная, 3. По умолчанию
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme) {
            applyTheme(savedTheme);
        } else {
            // Если в localStorage темы нет, используем системную
            const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
            applyTheme(prefersDark ? 'dark' : 'light');
        }

        // Слушаем изменения системной темы, если пользователь не выбрал свою
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
            if (!localStorage.getItem('theme')) {
                applyTheme(e.matches ? 'dark' : 'light');
            }
        });

        // 2. Определяем и применяем язык
        const browserLang = navigator.language || navigator.userLanguage;
        const initialLang = browserLang.startsWith('ru') ? 'ru' : 'en';
        applyLanguage(initialLang);

        // 3. Обрабатываем "поделенные" ссылки и запускаем остальные скрипты
        handleSharedLinkView();
        setupInterestLink('gamedev-interest-badge', 'games-projects');
        setupInterestLink('software-interest-badge', 'software-projects');
        setupRunawayButton();
        setupCopyToClipboard();
    });
